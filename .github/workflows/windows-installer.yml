name: Build Windows Installer

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine package version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF_TYPE -eq 'tag') {
            $ver = $env:GITHUB_REF_NAME.TrimStart('v')
          }
          else {
            $ver = "0.0.$($env:GITHUB_RUN_NUMBER)"
          }
          "PACKAGE_VERSION=$ver" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install WiX
        shell: pwsh
        run: dotnet tool install --global wix

      - name: Add dotnet tools to PATH
        shell: pwsh
        run: echo "$env:USERPROFILE\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install WiX extensions
        shell: pwsh
        run: |
          wix extension add -g WixToolset.Util.wixext
          wix extension add -g WixToolset.Harvest.wixext
          wix extension enable -g WixToolset.Util.wixext
          wix extension enable -g WixToolset.Harvest.wixext

      - name: Build MSI
        shell: pwsh
        run: |
          Set-Location packaging/windows
          ./build.ps1 -Version $env:PACKAGE_VERSION -OutputName "TimeTracker-$($env:PACKAGE_VERSION).msi"

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: timetracker-msi-${{ env.PACKAGE_VERSION }}
          path: packaging/windows/TimeTracker-${{ env.PACKAGE_VERSION }}.msi
